#! /bin/bash

# 
# This script imports a config file containing the necessary configuration to connect to a remote server
# It stores the files in settings
#

filename="${1}"
provider="${2}"
tunnel_id="${3}"
destination=`mktemp || -3`

cleanup()
{
    if [ -d ${TMPDIR} ] ; then
        rm -rf ${TMPDIR};  
    fi
    exit $1
}

setOption()
{
    if [ -z "`/bin/egrep \"^$1\" $3`" ] ; then
        echo "$1 $2" >> $3
    else
        sed -e "s/^$1[[:space:]]*.*/$1 $2/" -i $3
    fi
}

importZip()
{
    TMPDIR=`mktemp -d || exit -3`
    unzip -q ${filename} -d ${TMPDIR} || { rm -rf ${TMPDIR};  exit -1 ; }

    CONF_FILE="`ls ${TMPDIR}/untangle-vpn/*.conf`"
    if [ ! -f $CONF_FILE ] ; then
        echo "Unknown format: Missing conf file"
        cleanup 1
    fi

    # Copy file into place
    cp -Pf $CONF_FILE @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/tunnel.conf
    cp -Pf ${TMPDIR}/untangle-vpn/keys/* @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/keys/

    # Specify device explicitly
    setOption "dev" "tun${tunnel_id}" @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/tunnel.conf

    # Add up/down scripts
    setOption "script-security" "2" @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/tunnel.conf
    echo "up @PREFIX@/usr/share/untangle/bin/tunnel-vpn-up.sh" >> @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/tunnel.conf
    echo "down @PREFIX@/usr/share/untangle/bin/tunnel-vpn-down.sh" >> @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/tunnel.conf
}

importOvpn()
{
    if [[ ! "${filename}" == *ovpn ]] && [[ ! "${filename}" == *conf ]]; then
        echo "Unknown file extension: ${filename}"
        cleanup 1
    fi
    # Copy file into place
    cp -Pf ${filename} @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/tunnel.conf

    # Specify device explicitly
    setOption "dev" "tun${tunnel_id}" @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/tunnel.conf

    # Add up/down scripts
    setOption "script-security" "2" @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/tunnel.conf
    echo "up @PREFIX@/usr/share/untangle/bin/tunnel-vpn-up.sh" >> @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/tunnel.conf
    echo "down @PREFIX@/usr/share/untangle/bin/tunnel-vpn-down.sh" >> @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/tunnel.conf
}

if [ ! -f "${filename}" ]; then
    echo "Unable to find the file: ${filename}"
    cleanup 1
fi

mkdir -p @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/
mkdir -p @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/keys/


if [ "$provider" == "Untangle" ] ; then
    importZip
elif [ "$provider" == "NordVPN" ] ; then
    importOvpn
elif [ "$provider" == "ExpressVPN" ] ; then
    importOvpn
elif [ "$provider" == "CustomZip" ] ; then
    importZip
elif [ "$provider" == "CustomZipPass" ] ; then
    importZip
elif [ "$provider" == "CustomOvpn" ] ; then
    importOvpn
elif [ "$provider" == "CustomOvpnPass" ] ; then
    importOvpn
elif [ "$provider" == "CustomConf" ] ; then
    importOvpn
elif [ "$provider" == "CustomConfPass" ] ; then
    importOvpn
else     
    echo "Unknown provider: $provider"
    cleanup 1
fi

sed -e '/auth-user-pass.*/d' -i @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/tunnel.conf
echo "auth-user-pass auth.txt" >> @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/tunnel.conf
    
cleanup 0
