#! /bin/bash

# 
# This script imports a config file containing the necessary configuration to connect to a remote server
# It stores the files in settings
#

filename="${1}"
provider="${2}"
tunnel_id="${3}"
destination=`mktemp || -3`

cleanup()
{
#    if [ -d ${TMPDIR} ] ; then
#        rm -rf ${TMPDIR};  
#    fi
    exit $1
}

if [ ! -f "${filename}" ]; then
    echo "Unable to find the file: ${filename}"
    cleanup 1
fi

TMPDIR=`mktemp -d || exit -3`
unzip -q ${filename} -d ${TMPDIR} || { rm -rf ${TMPDIR};  exit -1 ; }

mkdir -p @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/
mkdir -p @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/keys/

if [ "$provider" == "Untangle" ] ; then
    CONF_FILE="`ls ${TMPDIR}/untangle-vpn/*.conf`"
    if [ ! -f $CONF_FILE ] ; then
        echo "Unknown format: Missing conf file"
        cleanup 1
    fi

    cp -Pf $CONF_FILE @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/tunnel.conf
    cp -Pf ${TMPDIR}/untangle-vpn/keys/* @PREFIX@/usr/share/untangle/settings/tunnel-vpn/tunnel-${tunnel_id}/keys/
else     
    echo "Unknown provider: $provider"
    cleanup 1
fi

cleanup 0
