#! /bin/bash

# 
# This script starts a tunnel VPN
#

tunnel_id=${1}
conf_dir=${2}
tunnel_name="tunnel-${tunnel_id}"
management_port=$((2000+${tunnel_id}))

mkdir -p /run/tunnelvpn

echo "Launching openvpn..."
/usr/sbin/openvpn \
    --config ${conf_dir}/tunnel.conf \
    --writepid /run/tunnelvpn/${tunnel_name}.pid \
    --daemon ovpn-${tunnel_name} \
    --dev tun${tunnel_id} \
    --cd ${conf_dir} \
    --log-append /var/log/uvm/tunnel.log \
    --auth-user-pass auth.txt \
    --script-security 2 \
    --up @PREFIX@/usr/share/untangle/bin/tunnel-vpn-up.sh \
    --down @PREFIX@/usr/share/untangle/bin/tunnel-vpn-down.sh \
    --management 127.0.0.1 ${management_port} \
    </dev/null &


