#!/bin/dash

## Script to handle ClamAV database download and service management
## Usage:
##   script.sh start  -> stop services, run freshclam, start services
##   script.sh stop  -> only stop services

SERVICES_STOP="clamav-freshclam.service clamav-daemon.service clamav-daemon.socket"
SERVICES_START="clamav-freshclam.service clamav-daemon.service"

ACTION="$1"

stop_services() {
    for svc in $SERVICES_STOP; do
        if systemctl is-active --quiet "$svc"; then
            systemctl stop "$svc" >/dev/null 2>&1
        fi
    done
}

start_services() {
    for svc in $SERVICES_START; do
        # Add small delay to allow systemd to settle
        sleep 1
        if systemctl is-active --quiet "$svc"; then
            echo "$svc is already running, skipping start." >/dev/null 2>&1
        else
            systemctl start "$svc" >/dev/null 2>&1
        fi
    done
}

run_freshclam() {
    /usr/bin/freshclam --foreground=true >/dev/null 2>&1
}

case "$ACTION" in
    start)
        stop_services
        run_freshclam
        start_services
        ;;
    stop)
        stop_services
        ;;
    *)
        echo "Usage: $0 {start|stop}" >/dev/null 2>&1
        ;;
esac