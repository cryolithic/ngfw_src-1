#!/usr/bin/env python
#
# Script to get the status of all wireguard interfaces and return to
# the caller as json object. We call 'wg show all dump' which gives us
# multiple lines per interface in the following format:
#
# The first line contains in order separated by tab:
# interface, private-key, public-key, listen-port, fwmark
#
# Subsequent lines for each peer contain in order separated by tab:
# interface, public-key, preshared-key, endpoint, allowed-ips,
# latest-handshake, transfer-rx, transfer-tx, persistent-keepalive
#
# Since there can be multiple peers per interface we use the field count
# per line to know when we're parsing data for an interface or a peer for
# the last interface we found. Lines with 5 fields have the interface details
# and lines with 9 fields have the details for one peer of that interface.
# Note that using the dump argument with wg causes each line to start with the
# interface name to help with exactly the kind of parsing we're doing here.

import subprocess
import json

# -----------------------------------------------------------------------------

def parse_output(parse_data):
    parse_lines = parse_data.split('\n')
    tunnel_info = []
    first_time = True
    face_index = 0
    peer_index = 0
    token = None

    # look at every line
    for line in parse_lines:

        # strip the line and parse the tokens
        line = line.strip()
        token = line.split()

        # ignore lines that do not have enough tokens
        if (len(token) < 5):
            continue

        # lines with 5 tokens indicate the start of an interface
        # peer lines will have 9 tokens
        if (len(token) == 5):

            # we only start incrementing face_index after the first time
            # through since we use the value when parsing peers
            if first_time == True:
                first_time = False
            else:
                face_index += 1

            tunnel_info.append({})
            tunnel_info[face_index]["interface"] = token[0]
            tunnel_info[face_index]["private-key"] = token[1]
            tunnel_info[face_index]["public-key"] = token[2]
            tunnel_info[face_index]["listen-port"] = token[3]
            tunnel_info[face_index]["fwmark"] = token[4]
            tunnel_info[face_index]["peers"] = []
            peer_index = 0
            continue

        peer_info = {}
        peer_info["public-key"] = token[1]
        peer_info["preshared-key"] = token[2]
        peer_info["endpoint"] = token[3]
        peer_info["allowed-ips"] = token[4]
        peer_info["latest-handshake"] = token[5]
        peer_info["transfer-rx"] = token[6]
        peer_info["transfer-tx"] = token[7]
        peer_info["persistent-keepalive"] = token[8]

        tunnel_info[face_index]["peers"].append([])
        tunnel_info[face_index]["peers"][peer_index] = peer_info
        peer_index += 1

    # return the tunnel_info array we created
    return tunnel_info

# -----------------------------------------------------------------------------

tunnel_status = {}

tunnel_proc = subprocess.Popen("/usr/bin/wg show all dump", stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=True)
(tunnel_out,tunnel_err) = tunnel_proc.communicate()
tunnel_raw = parse_output(tunnel_out)

tunnel_status["wireguard"] = tunnel_raw

tunnel_json = json.dumps(tunnel_status)
print tunnel_json

